---
description: Idempotent workspace environment setup, repair, migration, and status reporting
allowed-tools: [Task, Read, Write, AskUserQuestion]
---

<objective>
Manage the workspace environment through an idempotent command that detects current state and performs the appropriate action: setup, repair, migrate, or report.

This command delegates scanning work to parallel subagents to minimize main context usage.
</objective>

<execution_model>
This command uses a coordinator pattern:
1. **Main context**: State detection, orchestration, user interaction, final output
2. **Subagents**: All scanning and data gathering (runs in parallel, isolated context)

IMPORTANT: Immediately notify user that scanning is starting, then delegate.
</execution_model>

<process>
## Phase 1: Quick State Detection (Main Context)

Notify user immediately:
```
Starting workspace environment scan...
```

Check state with minimal reads:
1. Check if `.claude/workspace-info.toon` exists
2. If exists: read first 10 lines to get version
3. Determine action: setup | repair | migrate | report

| State | Condition | Action |
|-------|-----------|--------|
| **virgin** | File doesn't exist | Run SETUP via subagents |
| **healthy** | File exists, valid, version matches | Run REPORT (direct read) |
| **outdated** | File exists, version mismatch | Run MIGRATE via subagent |
| **corrupted** | File exists, invalid/incomplete | Run REPAIR via subagent |

## Phase 2: Delegate Scanning (Parallel Subagents)

For SETUP state, launch these subagents IN PARALLEL using a single message with multiple Task tool calls:

### Subagent 1: Standard Directories Scanner
```
Task(subagent_type="Explore", prompt="""
Scan workspace for standard capability-driven development directories.

Check for these directories at workspace root and report findings:
- capabilities/ → count **/capability_track.json files
- outcomes/ → count **/outcome_track.json files, note stage subdirs
- plans/ → count *.md files
- executions/ → count session logs
- research/ → check if exists
- status/ → check for capability_summary.json, outcome_summary.json

Return TOON format:
```
@type: ItemList
directories{name,exists,itemCount,path|tab}:
capabilities	true	5	./capabilities
outcomes	true	12	./outcomes
...
```
""")
```

### Subagent 2: Project & Technology Scanner
```
Task(subagent_type="Explore", prompt="""
Scan workspace for projects and technology indicators.

1. Check for project-map.json at root or .claude/
2. Scan for technology indicators:
   - package.json → Node.js/TypeScript
   - pyproject.toml, setup.py → Python
   - Cargo.toml → Rust
   - go.mod → Go
   - pom.xml, build.gradle → Java/Kotlin
   - pubspec.yaml → Flutter/Dart
   - *.csproj → .NET

3. Identify .git directories to find project boundaries

Return TOON format:
```
@type: ItemList
hasProjectMap: true|false
projectMapPath: {path}

projects{name,path,technology,gitRoot|tab}:
{name}	{path}	{tech}	{git-root}
...
```
""")
```

### Subagent 3: IDE Configuration Scanner
```
Task(subagent_type="Explore", prompt="""
Scan for IntelliJ IDEA configuration in .idea/ directory.

If .idea/ exists, extract:
1. From modules.xml: module names and paths
2. From misc.xml: SDK name, language level
3. From vcs.xml: VCS mappings
4. List *.iml files found

Return TOON format:
```
@type: SoftwareApplication
ide.name: IntelliJ IDEA
ide.configPath: .idea/
ide.sdkName: {sdk}
ide.languageLevel: {level}

ide.modules{name,path,type|tab}:
{module}	{path}	{type}
...

ide.vcsRoots{directory,vcs|tab}:
{dir}	Git
...
```

If no .idea/ directory, return:
```
@type: SoftwareApplication
ide.name: none
```
""")
```

### Subagent 4: Git & Workspace Metadata
```
Task(subagent_type="Explore", prompt="""
Gather git and workspace metadata.

Execute and report:
1. git rev-parse --short HEAD
2. git remote get-url origin
3. git log -1 --format=%cI (commit timestamp)
4. basename of workspace directory

Return TOON format:
```
@type: Project
workspace.name: {directory-name}
workspace.codeRepository: {remote-url}
workspace.version: {commit-hash}
workspace.dateModified: {commit-timestamp}
```
""")
```

## Phase 3: Merge Results (Main Context)

After all subagents complete:
1. Collect TOON outputs from each subagent
2. Merge into unified workspace-info.toon structure
3. If SETUP: present summary and ask user to confirm
4. Write .claude/workspace-info.toon

## Phase 4: User Confirmation (SETUP only)

Present merged findings:
```
## Workspace Scan Complete

Workspace: {name} @ {commit}
Repository: {remote-url}

### Projects ({count})
{project-list}

### Standard Directories
{directory-summary}

### IDE Integration
{ide-summary}

Proceed with workspace initialization? [Y/n]
```

## Phase 5: Generate Output File

Write workspace-info.toon using template from collected data.
</process>

<workspace_info_template>
```toon
# Workspace Environment Snapshot
# Generated by ws plugin - DO NOT EDIT MANUALLY
# Use /ws:enviro to update

@context: https://schema.org
@type: SoftwareSourceCode
@id: workspace/{workspace-name}
dateCreated: {timestamp}
dateModified: {timestamp}
softwareVersion: 0.1.1

# ─── Workspace ───────────────────────────────────────────
workspace@type: Project
workspace.name: {workspace-name}
workspace.codeRepository: {github-url}
workspace.version: {commit-hash}
workspace.dateModified: {commit-timestamp}

# ─── Projects ────────────────────────────────────────────
projects@type: ItemList
projects.numberOfItems: {count}

project{name,codeRepository,version,dateModified,path,@type,technologies|tab}:
{merged-from-subagent-2}

# ─── Capabilities ────────────────────────────────────────
capabilities@type: ItemList
capabilities.path: {path}
capabilities.numberOfItems: {count}

# ─── Outcomes ────────────────────────────────────────────
outcomes@type: ItemList
outcomes.path: {path}

outcomes.summary{stage,count,path|tab}:
{merged-from-subagent-1}

# ─── IDE Integration ─────────────────────────────────────
{merged-from-subagent-3}

# ─── Current Focus ───────────────────────────────────────
focus@type: Action
focus.name: {none}
focus.target: {none}
focus.actionStatus: PotentialActionStatus
```
</workspace_info_template>

<report_mode>
For REPORT state (healthy workspace-info.toon exists):
- Read the file directly (no subagents needed)
- Display formatted summary to user
- No context pollution since it's a single read

Output format:
```
## Workspace Status

{workspace-name} @ {commit-short}
Last updated: {relative-time}

### Projects ({count})
{project-table}

### Capabilities ({count})
{capability-summary}

### Outcomes
- Queued: {n}
- In Progress: {n}
- Completed: {n}

### Current Focus
{focus-name} ({focus-path})
```
</report_mode>

<migrate_mode>
For MIGRATE state, launch single subagent:
```
Task(subagent_type="general-purpose", prompt="""
Migrate workspace-info.toon from old version to current.

1. Read existing .claude/workspace-info.toon
2. Identify version from softwareVersion field
3. Apply migrations for each version step
4. Preserve all existing data
5. Add any new required fields with defaults
6. Update softwareVersion to 0.1.1
7. Write updated file

Return summary of changes made.
""")
```
</migrate_mode>

<repair_mode>
For REPAIR state, launch single subagent:
```
Task(subagent_type="general-purpose", prompt="""
Repair corrupted workspace-info.toon.

1. Read existing .claude/workspace-info.toon
2. Identify which sections are valid vs corrupted
3. For corrupted sections, rescan filesystem to regenerate
4. Preserve all valid data
5. Write repaired file

Return summary of repairs made.
""")
```
</repair_mode>

<output_format>
**Progress Notification** (immediate):
```
Starting workspace environment scan...
Launching parallel scanners for directories, projects, IDE config...
```

**SETUP Complete**:
```
## Workspace Environment Initialized

Workspace: {name}
Repository: {url}
Plugin: ws v0.1.1

Projects: {count} discovered
Capabilities: {count} tracked
Outcomes: {count} total

Created: .claude/workspace-info.toon
```

**REPORT Complete**:
```
## Workspace Status

{name} @ {commit}
...
```

**MIGRATE Complete**:
```
## Workspace Migrated

From: ws v{old} → v{new}
Changes: {summary}
```

**REPAIR Complete**:
```
## Workspace Repaired

Fixed: {list}
Preserved: {count} sections
```
</output_format>

<success_criteria>
- User notified immediately that scan is starting
- Scanning delegated to parallel subagents (not main context)
- Main context only handles: state detection, orchestration, user prompts, final output
- Results merged efficiently from subagent TOON outputs
- workspace-info.toon valid after execution
- Minimal main context token usage
</success_criteria>
