# Failure Handling Reference

## Failure Categories

| Category | Exit Behavior | Recovery |
|----------|--------------|----------|
| DEPENDENCY_MISSING | Halt immediately | Install dependency, resume |
| PHASE_FAILED | Continue to next phase | Fix and re-run phase |
| CHECK_FAILED | Continue other checks | Manual fix required |
| TIMEOUT | Mark timed out, continue | Increase timeout, retry |
| CONTEXT_EXHAUSTED | Write checkpoint, halt | Resume from checkpoint |

## Dependency Failures

### DEPENDENCY_UNCLEAR

```
Cannot determine if '{class_name}' is pre-existing or created.
Design reference: {location in docs}
Resolution required: Clarify in design documents.
```

### PREREQ_MISSING

```
Pre-existing dependency '{class_name}' not found.
Expected location: {path}
Resolution: Implement before running this execution.
```

### CIRCULAR_DEPENDENCY

```
Circular dependency detected: {A} → {B} → {C} → {A}
Resolution: Refactor design to break the cycle.
```

## Version Handling

| Situation | Action |
|-----------|--------|
| Library not installed | Add installation step to plan |
| Minor/patch version lower | Upgrade automatically |
| Major version mismatch | FAIL - requires user decision |
| Version not specified | Use latest stable, log warning |

## Fix Attempt Escalation

### Attempt 1-2: Sonnet

```python
Task(
    model="sonnet",
    prompt=f"""
    Fix the following issue:

    Check: {check_name}
    Failure: {failure_details}
    Location: {file}:{line}

    Previous attempts: {previous_attempts}

    Provide a targeted fix.
    """
)
```

### Attempt 3: Opus with Extended Thinking

```python
Task(
    model="opus",
    prompt=f"""
    [EXTENDED THINKING REQUIRED]

    Previous fix attempts have failed. Deep analysis required.

    Check: {check_name}
    Failure: {failure_details}

    Previous attempts:
    - Attempt 1: {attempt_1_action} → {attempt_1_result}
    - Attempt 2: {attempt_2_action} → {attempt_2_result}

    Requirements:
    1. Analyze root cause thoroughly
    2. Consider systemic issues
    3. Propose comprehensive fix
    4. Explain why previous attempts failed
    """
)
```

### After 3 Failures

- Mark check as FAILED
- Continue with other checks
- Include in failure report
- Require manual intervention

## Report Structures

### implementation_report.md

```markdown
# Implementation Report: [System Name]

Generated: [ISO timestamp]
Execution ID: [uuid]
Status: SUCCESS | FAILED | PARTIAL

---

## Executive Summary

[2-3 sentence summary of what was implemented and final status]

---

## Execution Metrics

### Time & Cost

| Metric | Planned | Actual | Variance |
|--------|---------|--------|----------|
| Duration | [X] min | [Y] min | [±Z]% |
| Total Tokens | [X] | [Y] | [±Z]% |
| Estimated Cost | $[X] | $[Y] | [±Z]% |

### Model Usage

| Model | Calls | Input Tokens | Output Tokens | Cost |
|-------|-------|--------------|---------------|------|
| Haiku | [n] | [x] | [y] | $[z] |
| Sonnet | [n] | [x] | [y] | $[z] |
| Opus | [n] | [x] | [y] | $[z] |

---

## Cross-Check Results

### Summary

| Check | Status | Details |
|-------|--------|---------|
| Lint | PASS/FAIL | [errors fixed, warnings] |
| Coverage | PASS/FAIL | [X]% (threshold: 80%) |
| Style | PASS/FAIL | [violations] |
| Architecture | PASS/FAIL | [patterns verified] |
| Requirements | PASS/FAIL | [N/M verified] |
| Acceptance | PASS/FAIL/SKIP | [details] |
| Documentation | PASS/FAIL | [symbols documented] |
| Custom | PASS/FAIL | [criteria met] |

### Fix Attempts (if any)

| Check | Attempt | Model | Action | Result |
|-------|---------|-------|--------|--------|
| [check] | 1 | sonnet | [action] | [result] |
| [check] | 2 | sonnet | [action] | [result] |
| [check] | 3 | opus | [action] | [result] |

---

## Failures (if any)

### [Check Name]: FAILED

**Description**: [what failed]
**Root Cause**: [opus analysis]
**Recommended Resolution**: [next steps]

---

*Generated by Meta-Prompt v8.0.0*
```

### execution_result.json

```json
{
  "execution_id": "uuid",
  "status": "SUCCESS|FAILED|PARTIAL",
  "system_name": "string",
  "started_at": "ISO timestamp",
  "completed_at": "ISO timestamp",
  "duration_seconds": 0,

  "summary": {
    "phases_completed": 8,
    "phases_failed": 0,
    "tdd_cycles": 78,
    "files_created": 12,
    "tests_written": 73,
    "coverage_percent": 87.3
  },

  "token_usage": {},

  "cross_check_results": {
    "lint": {"status": "pass", "errors_fixed": 0, "warnings_fixed": 3},
    "coverage": {"status": "pass", "percent": 87.3, "threshold": 80},
    "style": {"status": "pass", "violations": 0},
    "architecture": {"status": "pass", "patterns_verified": 5},
    "requirements": {"status": "pass", "verified": 50, "total": 50},
    "acceptance": {"status": "skipped", "reason": "Not defined"},
    "documentation": {"status": "pass", "symbols": 45, "documented": 45},
    "custom": {"status": "pass", "criteria_met": 4, "total": 4}
  },

  "failures": [
    {
      "phase": "phase_8_crosscheck",
      "check": "coverage",
      "description": "Coverage below threshold",
      "attempts": [],
      "root_cause": "Opus analysis",
      "resolution": "Manual intervention required"
    }
  ],

  "git": {
    "committed": true,
    "commit_hash": "abc123",
    "branch": "feature/system-name"
  },

  "artifacts": {
    "source_files": [],
    "test_files": [],
    "reports": ["implementation_report.md", "execution_result.json"]
  }
}
```

## File Locations

All tracking files in execution output directory:

- `{output_dir}/status.json` - Phase progress
- `{output_dir}/checkpoint.json` - Resume capability
- `{output_dir}/audit_trail.json` - Token tracking
- `{output_dir}/execution_result.json` - Final results
- `{output_dir}/implementation_report.md` - Human-readable report
